<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Dashboard Ph·∫£n H·ªìi Ch·∫•m C√¥ng</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body {
        font-family: Arial;
        margin: 20px;
        background: #fafafa;
        transition: background 0.3s, color 0.3s;
    }

    /* Auto Dark Mode */
    @media (prefers-color-scheme: dark) {
        body { background: #1e1e1e; color: white; }
        table { background: #2a2a2a; color: white; }
        th { background: #333 !important; }
        .box { background: #2d2d2d; box-shadow: none; }
        input { background: #333; color: white; border: 1px solid #555; }
    }

    h1 { margin-bottom: 5px; }
    h2 { margin-top: 20px; }

    .search-bar input {
        padding: 8px;
        width: 170px;
        margin-right: 5px;
    }

    .search-bar button {
        padding: 8px 12px;
        cursor: pointer;
    }

    .chart-row {
        display: flex;
        gap: 20px;
        width: 100%;
    }

    .box {
        background: white;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        flex: 1;
        min-width: 260px;
    }

    .box-third { flex: 0.33; }
    .box-two-third { flex: 0.67; }
    .box-full { flex: 1; }

    table { 
        width: 100%; 
        border-collapse: collapse; 
        margin-top: 20px; 
        background: white;
    }

    th, td {
        padding: 10px;
        border-bottom: 1px solid #ddd;
        font-size: 14px;
    }

    th { background: #f0f0f0; cursor: pointer; user-select: none; }

    .badge { 
        padding: 4px 12px; 
        border-radius: 16px;
        font-size: 12px; 
        color: #fff;
    }

    .confirm-none { background: #ff6b6b; }
    .confirm-done { background: #2ecc71; }

    audio { display: none; }
</style>
</head>

<body>

<h1>Dashboard Ph·∫£n H·ªìi Ch·∫•m C√¥ng</h1>
<p>üìå D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông ‚ù§Ô∏èü´∂‚ù§Ô∏è.</p>

<!-- SEARCH BAR -->
<div class="search-bar">
    <input id="searchMSNV" placeholder="T√¨m theo MSNV‚Ä¶" oninput="applySearch()">
    <input id="searchName" placeholder="T√¨m theo h·ªç t√™n‚Ä¶" oninput="applySearch()">
    <button onclick="resetFilter()">X√≥a l·ªçc</button>
</div>

<h3 style="margin-top:25px;">Danh s√°ch chi ti·∫øt</h3>

<table id="dataTable">
    <thead>
        <tr>
            <th onclick="sortTable('MSNV')">MSNV ‚¨ç</th>
            <th>H·ªç t√™n</th>
            <th onclick="sortTable('NgayDieuChinh')">Ng√†y c·∫ßn ƒëi·ªÅu ch·ªânh ‚¨ç</th>
            <th>N·ªôi dung</th>
            <th>Confirm Admin</th>
            <th>BU</th>
            <th>Team</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- FOOTER CHARTS -->
<h2 style="margin-top:40px;">Bi·ªÉu ƒë·ªì ph·ª•</h2>

<!-- BU + Team -->
<div class="chart-row">
    <div class="box box-third">
        <h4>Theo BU</h4>
        <canvas id="chartBU"></canvas>
    </div>

    <div class="box box-two-third">
        <h4>Theo Team</h4>
        <canvas id="chartTeam"></canvas>
    </div>
</div>

<!-- Top ph·∫£n h·ªìi -->
<div class="chart-row">
    <div class="box box-full">
        <h4>Top ph·∫£n h·ªìi</h4>
        <canvas id="chartTop"></canvas>
    </div>
</div>

<!-- Theo ng√†y ch·ªânh -->
<div class="chart-row">
    <div class="box box-full">
        <h4>Theo ng√†y ch·ªânh</h4>
        <canvas id="chartNgayChinh"></canvas>
    </div>
</div>

<!-- BACKGROUND MUSIC -->
<audio id="bgMusic" loop>
    <source src="videoplayback.m4a" type="audio/mp4">
</audio>

<script>
// ================== CONFIG ==================
const jsonUrl = "https://hoailuan0311-code.github.io/ChamCongDashboard/data.json";

// Convert Excel serial date
function excelSerialToDate(v) {
    if (!v) return "";
    const d = new Date((v - 25569) * 86400 * 1000);
    if (isNaN(d)) return "";
    return d;
}

// Format dd-MMM-yyyy
function excelDate(v) {
    let d = excelSerialToDate(v);
    if (!d) return "";
    return d.toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" });
}

let fullData = [];
let sortState = {};

// ================== LOAD DATA ==================
async function loadData() {
    let res = await fetch(jsonUrl + "?cache=" + Date.now());
    fullData = await res.json();
    renderAll(fullData);
}
loadData();

// ================== RENDER EVERYTHING ==================
function renderAll(data) {
    renderTable(data);
    renderTop(data);
    renderBU(data);
    renderTeam(data);
    renderNgayChinh(data);
}

// ================== TABLE ==================
function renderTable(data) {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    data.forEach(r => {
        tbody.innerHTML += `
        <tr>
            <td>${r.MSNV || ""}</td>
            <td>${r.FullName || ""}</td>
            <td>${excelDate(r.NgayDieuChinh)}</td>
            <td>${r.NoiDung || ""}</td>
            <td><span class="badge ${r.ConfirmAdmin ? "confirm-done" : "confirm-none"}">
                ${r.ConfirmAdmin || "Ch∆∞a ph·∫£n h·ªìi"}
            </span></td>
            <td>${r.BU || ""}</td>
            <td>${r.Team || ""}</td>
        </tr>`;
    });
}

// ================== SORT ==================
function sortTable(column) {
    sortState[column] = !sortState[column];

    let sorted = [...fullData];

    sorted.sort((a, b) => {
        let valA = a[column], valB = b[column];

        if (column === "MSNV") {
            valA = Number(valA) || 0;
            valB = Number(valB) || 0;
        }

        if (column === "NgayDieuChinh") {
            valA = excelSerialToDate(valA);
            valB = excelSerialToDate(valB);
        }

        if (valA < valB) return sortState[column] ? -1 : 1;
        if (valA > valB) return sortState[column] ? 1 : -1;
        return 0;
    });

    renderAll(sorted);
}

// ================== SEARCH ==================
function applySearch() {
    let msnv = searchMSNV.value.trim().toLowerCase();
    let name = searchName.value.trim().toLowerCase();

    let filtered = fullData.filter(r =>
        (!msnv || (r.MSNV || "").toLowerCase().includes(msnv)) &&
        (!name || (r.FullName || "").toLowerCase().includes(name))
    );

    renderAll(filtered);
}

function resetFilter() {
    searchMSNV.value = "";
    searchName.value = "";
    renderAll(fullData);
}

// ================== CHARTS ==================
function animateCfg() {
    return {
        animation: {
            duration: 1200,
            easing: "easeOutBounce"
        }
    };
}

function renderTop(data) {
    const counts = {};
    data.forEach(r => counts[r.FullName] = (counts[r.FullName] || 0) + 1);
    let sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);

    new Chart(chartTop, {
        type: "bar",
        data:{
            labels: sorted.map(x=>x[0]),
            datasets:[{
                label: "S·ªë ph·∫£n h·ªìi",
                data: sorted.map(x=>x[1]),
                backgroundColor:"#4C8BF5"
            }]
        },
        options: animateCfg()
    });
}

function renderBU(data) {
    const counts = {};
    data.forEach(r => counts[r.BU] = (counts[r.BU] || 0) + 1);

    new Chart(chartBU, {
        type:"pie",
        data:{
            labels: Object.keys(counts),
            datasets:[{
                label: "S·ªë ph·∫£n h·ªìi",
                data:Object.values(counts),
                backgroundColor:["#ff6384","#36a2eb","#ffce56","#66bb6a","#ba68c8"]
            }]
        },
        options: animateCfg()
    });
}

function renderTeam(data) {
    const counts = {};
    data.forEach(r => counts[r.Team] = (counts[r.Team] || 0) + 1);

    new Chart(chartTeam, {
        type:"bar",
        data:{
            labels:Object.keys(counts),
            datasets:[{
                label:"S·ªë ph·∫£n h·ªìi",
                data:Object.values(counts),
                backgroundColor:"#ff7043"
            }]
        },
        options: animateCfg()
    });
}

function renderNgayChinh(data) {
    const counts = {};
    data.forEach(r => {
        let d = excelDate(r.NgayDieuChinh);
        if(d) counts[d] = (counts[d] || 0) + 1;
    });

    new Chart(chartNgayChinh, {
        type:"bar",
        data:{
            labels:Object.keys(counts),
            datasets:[{
                label:"S·ªë ph·∫£n h·ªìi",
                data:Object.values(counts),
                backgroundColor:"#9b59b6"
            }]
        },
        options: animateCfg()
    });
}

// ================== AUTO MUSIC ==================
const music = document.getElementById("bgMusic");
document.addEventListener("touchstart", () => music.play(), { once:true });
document.addEventListener("click", () => music.play(), { once:true });
music.play().catch(()=>{});
</script>

</body>
</html>
