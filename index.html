<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard Ph·∫£n H·ªìi Ch·∫•m C√¥ng</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    body { font-family: Arial; margin: 20px; background: #fafafa; }
    h1 { margin-bottom: 5px; }
    h2 { margin-top: 25px; }
    .box {
        background: white;
        padding: 15px;
        border-radius: 12px;
        box-shadow: 0px 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }

    /* Khu v·ª±c 4 charts nh·ªè d∆∞·ªõi c√πng */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        background: white;
    }
    th, td {
        padding: 8px;
        border-bottom: 1px solid #ddd;
        font-size: 14px;
    }
    th { background: #f0f0f0; }
    input { padding: 8px; width: 240px; margin-right: 5px; }
    .badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
    }
    .confirm-none { background: #ffe3e3; color: #c00; }
    .confirm-done { background: #d4ffe3; color: #007a2f; }
</style>
</head>

<body>

<!-- Auto play nh·∫°c -->
<audio autoplay loop>
    <source src="https://raw.githubusercontent.com/hoailuan0311-code/ChamCongDashboard/main/audio/background.mp3" type="audio/mpeg">
</audio>

<h1>Dashboard Ph·∫£n H·ªìi Ch·∫•m C√¥ng</h1>
<p>üìå D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông.</p>

<!-- T√¨m ki·∫øm -->
<div>
    <input id="searchMSNV" placeholder="T√¨m theo MSNV‚Ä¶">
    <input id="searchName" placeholder="T√¨m theo h·ªç t√™n‚Ä¶">
    <button onclick="applySearch()">L·ªçc</button>
</div>

<h2>Th·ªëng k√™</h2>

<!-- T·ªïng quan -->
<div class="box">
    <h3>T·ªïng quan</h3>
    <canvas id="chartDays"></canvas>
</div>

<!-- Top ph·∫£n h·ªìi -->
<div class="box">
    <h3>Top ph·∫£n h·ªìi</h3>
    <canvas id="chartTop"></canvas>
</div>

<!-- KHU V·ª∞C 4 BI·ªÇU ƒê·ªí NH·ªé D∆Ø·ªöI C√ôNG -->
<div class="stats-grid">

    <div class="box">
        <h3>Theo BU</h3>
        <canvas id="chartBU"></canvas>
    </div>

    <div class="box">
        <h3>Theo Team (Bar Chart)</h3>
        <canvas id="chartTeam"></canvas>
    </div>

</div>

<h2>Danh s√°ch chi ti·∫øt</h2>

<table id="dataTable">
<thead>
<tr>
    <th>Date</th>
    <th>MSNV</th>
    <th>H·ªç t√™n</th>
    <th>Ng√†y c·∫ßn ƒëi·ªÅu ch·ªânh</th>
    <th>N·ªôi dung</th>
    <th>Email</th>
    <th>Confirm Admin</th>
    <th>BU</th>
    <th>Team</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const jsonUrl = "https://hoailuan0311-code.github.io/ChamCongDashboard/data.json";

function excelDateToString(v) {
    if (!v) return "";
    let d = new Date((v - 25569) * 86400 * 1000);
    return isNaN(d) ? v : d.toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" });
}

let fullData = [];

async function loadData() {
    let res = await fetch(jsonUrl + "?t=" + Date.now());
    fullData = await res.json();
    renderAll(fullData);
}

function renderAll(data) {
    renderTable(data);
    renderSummary(data);
    renderTop(data);
    renderBU(data);
    renderTeam(data);
}

function renderTable(data) {
    let tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";
    data.forEach(r => {
        tbody.innerHTML += `
        <tr>
            <td>${excelDateToString(r.Date)}</td>
            <td>${r.MSNV || ""}</td>
            <td>${r.FullName || ""}</td>
            <td>${excelDateToString(r.NgayDieuChinh)}</td>
            <td>${r.NoiDung || ""}</td>
            <td>${r.Email || ""}</td>
            <td><span class="badge ${r.ConfirmAdmin ? "confirm-done" : "confirm-none"}">
                ${r.ConfirmAdmin || "Ch∆∞a ph·∫£n h·ªìi"}
            </span></td>
            <td>${r.BU || ""}</td>
            <td>${r.Team || ""}</td>
        </tr>`;
    });
}

function applySearch() {
    let ms = searchMSNV.value.toLowerCase();
    let nm = searchName.value.toLowerCase();

    let f = fullData.filter(r =>
        (!ms || (r.MSNV || "").toLowerCase().includes(ms)) &&
        (!nm || (r.FullName || "").toLowerCase().includes(nm))
    );

    renderAll(f);
}

/* T·ªïng quan ng√†y */
function renderSummary(data) {
    let counts = {};
    data.forEach(r => counts[r.Date] = (counts[r.Date] || 0) + 1);
    new Chart(chartDays, {
        type: "bar",
        data: {
            labels: Object.keys(counts).map(excelDateToString),
            datasets: [{ label:"S·ªë ph·∫£n h·ªìi", data:Object.values(counts), backgroundColor:"#4C8BF5" }]
        }
    });
}

/* Top ph·∫£n h·ªìi */
function renderTop(data) {
    let c = {};
    data.forEach(r => c[r.FullName] = (c[r.FullName] || 0) + 1);
    let top = Object.entries(c).sort((a,b)=>b[1]-a[1]).slice(0,10);
    new Chart(chartTop, {
        type: "bar",
        data: {
            labels: top.map(x=>x[0]),
            datasets: [{ label:"S·ªë ph·∫£n h·ªìi", data:top.map(x=>x[1]), backgroundColor:"#00AEEF" }]
        }
    });
}

/* Theo BU */
function renderBU(data) {
    let c = {};
    data.forEach(r => c[r.BU] = (c[r.BU] || 0) + 1);
    new Chart(chartBU, {
        type:"pie",
        data:{
            labels:Object.keys(c),
            datasets:[{ data:Object.values(c), backgroundColor:["#FF6384","#36A2EB","#FFCE56","#4CAF50","#BA68C8"] }]
        }
    });
}

/* Theo Team ‚Üí BAR CHART */
function renderTeam(data) {
    let c = {};
    data.forEach(r => c[r.Team] = (c[r.Team] || 0) + 1);
    new Chart(chartTeam, {
        type:"bar",
        data:{
            labels:Object.keys(c),
            datasets:[{
                label:"S·ªë ph·∫£n h·ªìi",
                data:Object.values(c),
                backgroundColor:"#FF8A65"
            }]
        },
        options:{
            indexAxis: "y"
        }
    });
}

loadData();
</script>

</body>
</html>
