<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Dashboard Ph·∫£n H·ªìi Ch·∫•m C√¥ng</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Chart.js + DataLabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #fafafa;
        color: #111827;
        transition: background 0.3s, color 0.3s;
    }

    /* Header gradient */
    h1 {
        margin-bottom: 5px;
        font-weight: 900;
        font-size: 26px;
        background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        -webkit-background-clip: text;
        color: transparent;
    }

    h2 {
        margin-top: 24px;
        font-size: 18px;
    }

    h3 {
        margin-top: 24px;
        font-size: 16px;
    }

    h4 {
        margin: 0 0 8px 0;
        font-size: 14px;
    }

    /* Search bar */
    .search-bar {
        margin-top: 8px;
        margin-bottom: 8px;
    }

    .search-bar input {
        padding: 8px;
        width: 170px;
        margin-right: 5px;
        border-radius: 6px;
        border: 1px solid #d1d5db;
        font-size: 13px;
    }

    .search-bar button {
        padding: 8px 12px;
        cursor: pointer;
        border-radius: 6px;
        border: none;
        font-size: 13px;
        color: #fff;
        background: linear-gradient(90deg, #00c6ff, #0072ff);
        transition: 0.2s;
    }

    .search-bar button:hover {
        opacity: 0.85;
        transform: translateY(-1px);
    }

    /* Table */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 16px;
        background: #ffffff;
        border-radius: 10px;
        overflow: hidden;
    }

    th, td {
        padding: 10px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 13px;
        text-align: left;
    }

    th {
        background: #f3f4f6;
        cursor: pointer;
        user-select: none;
        font-weight: 600;
    }

    th.sortable::after {
        content: " ‚¨ç";
        font-size: 11px;
        color: #9ca3af;
    }

    tr:nth-child(even) td {
        background: #fbfbfb;
    }

    .badge {
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        color: #fff;
        white-space: nowrap;
    }

    .confirm-none { background: #ef4444; }
    .confirm-done { background: #22c55e; }

    /* Footer charts layout */
    .chart-row {
        display: flex;
        gap: 20px;
        width: 100%;
        flex-wrap: wrap;
        margin-top: 16px;
    }

    .box {
        background: #ffffff;
        padding: 14px;
        border-radius: 14px;
        box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
        flex: 1;
        min-width: 260px;
    }

    .box-third { flex: 0.33; }
    .box-two-third { flex: 0.67; }
    .box-full { flex: 1; }

    canvas {
        width: 100% !important;
        height: 260px !important;
    }

    /* Pagination */
    .pagination {
        margin-top: 10px;
    }

    .pagination button {
        margin: 0 2px;
        padding: 4px 8px;
        font-size: 12px;
        border-radius: 4px;
        border: 1px solid #d1d5db;
        background: #ffffff;
        cursor: pointer;
    }

    .pagination button.active {
        background: #2563eb;
        color: #ffffff;
        border-color: #2563eb;
    }

    .pagination button:disabled {
        opacity: 0.4;
        cursor: default;
    }

    /* Hidden audio */
    audio { display: none; }

    /* ====== DARK MODE ====== */
    @media (prefers-color-scheme: dark) {
        body {
            background: #111827;
            color: #e5e7eb;
        }

        h1 {
            background: linear-gradient(90deg, #8e9eab 0%, #eef2f3 100%);
            -webkit-background-clip: text;
            color: transparent;
        }

        table {
            background: #1f2933;
        }

        th {
            background: #374151 !important;
            color: #e5e7eb;
        }

        td {
            background: #111827;
            border-bottom: 1px solid #374151;
            color: #f9fafb !important;
        }

        tr:nth-child(even) td {
            background: #1f2933;
        }

        .box {
            background: #1f2933;
            box-shadow: 0 0 12px rgba(0,0,0,0.5);
        }

        .search-bar input {
            background: #111827;
            color: #e5e7eb;
            border-color: #374151;
        }

        .search-bar button {
            background: linear-gradient(90deg, #434343, #000000);
        }

        .pagination button {
            background: #111827;
            border-color: #4b5563;
            color: #e5e7eb;
        }

        .pagination button.active {
            background: #4f46e5;
            border-color: #4f46e5;
            color: #e5e7eb;
        }

        .confirm-none { background: #dc2626; }
        .confirm-done { background: #16a34a; }
    }
</style>
</head>

<body>

<h1>Dashboard Ph·∫£n H·ªìi Ch·∫•m C√¥ng - WAREHOUSE RYOBI</h1>
<p>üìå D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông ‚ù§Ô∏èü´∂‚ù§Ô∏è</p>

<!-- SEARCH BAR -->
<div class="search-bar">
    <input id="searchMSNV" placeholder="T√¨m theo MSNV‚Ä¶" oninput="applySearch()">
    <input id="searchName" placeholder="T√¨m theo h·ªç t√™n‚Ä¶" oninput="applySearch()">
    <button onclick="resetFilter()">X√≥a l·ªçc</button>
</div>

<h3>Danh s√°ch chi ti·∫øt</h3>

<table id="dataTable">
    <thead>
        <tr>
            <th class="sortable" onclick="sortTable('MSNV')">MSNV</th>
            <th>H·ªç t√™n</th>
            <th class="sortable" onclick="sortTable('NgayDieuChinh')">Ng√†y c·∫ßn ƒëi·ªÅu ch·ªânh</th>
            <th>N·ªôi dung</th>
            <th>Confirm Admin</th>
            <th>BU</th>
            <th>Team</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<div id="pagination" class="pagination"></div>

<h2>Bi·ªÉu ƒë·ªì ph·ª•</h2>

<!-- BU + Team -->
<div class="chart-row">
    <div class="box box-third">
        <h4>Theo BU</h4>
        <canvas id="chartBU"></canvas>
    </div>

    <div class="box box-two-third">
        <h4>Theo Team</h4>
        <canvas id="chartTeam"></canvas>
    </div>
</div>

<!-- Top ph·∫£n h·ªìi -->
<div class="chart-row">
    <div class="box box-full">
        <h4>Top ph·∫£n h·ªìi</h4>
        <canvas id="chartTop"></canvas>
    </div>
</div>

<!-- Theo ng√†y ch·ªânh -->
<div class="chart-row">
    <div class="box box-full">
        <h4>Theo ng√†y ch·ªânh</h4>
        <canvas id="chartNgayChinh"></canvas>
    </div>
</div>

<!-- BACKGROUND MUSIC -->
<audio id="bgMusic" loop>
    <!-- ƒê·ªïi sang link file c·ªßa b·∫°n n·∫øu c·∫ßn -->
    <source src="videoplayback.m4a" type="audio/mp4">
</audio>

<script>
// ================== CONFIG ==================
const jsonUrl = "https://hoailuan0311-code.github.io/ChamCongDashboard/data.json";

function excelSerialToDate(v) {
    if (!v) return null;
    const d = new Date((v - 25569) * 86400 * 1000);
    return isNaN(d) ? null : d;
}

function excelDate(v) {
    const d = excelSerialToDate(v);
    if (!d) return "";
    return d.toLocaleDateString("en-GB", { day:"2-digit", month:"short", year:"numeric" });
}

let fullData = [];
let viewData = [];
let sortState = {};
let currentPage = 1;
const rowsPerPage = 50;

// chart instances
let chartBUInstance, chartTeamInstance, chartTopInstance, chartNgayInstance;

// ================== LOAD DATA ==================
async function loadData() {
    const res = await fetch(jsonUrl + "?cache=" + Date.now());
    fullData = await res.json();
    viewData = [...fullData];
    currentPage = 1;
    renderAll(viewData);
}
loadData();

// ================== PAGINATION ==================
function paginate(data) {
    const start = (currentPage - 1) * rowsPerPage;
    return data.slice(start, start + rowsPerPage);
}

function renderPagination(totalRows) {
    const container = document.getElementById("pagination");
    container.innerHTML = "";
    const totalPages = Math.ceil(totalRows / rowsPerPage);
    if (totalPages <= 1) return;

    const makeBtn = (text, page, disabled = false, active = false) => {
        const btn = document.createElement("button");
        btn.textContent = text;
        if (disabled) btn.disabled = true;
        if (active) btn.classList.add("active");
        btn.onclick = () => {
            if (!disabled) {
                currentPage = page;
                renderAll(viewData);
            }
        };
        container.appendChild(btn);
    };

    makeBtn("¬´", 1, currentPage === 1);
    makeBtn("<", Math.max(1, currentPage - 1), currentPage === 1);

    for (let p = 1; p <= totalPages; p++) {
        makeBtn(p, p, false, p === currentPage);
    }

    makeBtn(">", Math.min(totalPages, currentPage + 1), currentPage === totalPages);
    makeBtn("¬ª", totalPages, currentPage === totalPages);
}

// ================== RENDER EVERYTHING ==================
function renderAll(data) {
    const pageData = paginate(data);
    renderTable(pageData);
    renderPagination(data.length);
    destroyCharts();
    renderBU(data);
    renderTeam(data);
    renderTop(data);
    renderNgayChinh(data);
}

// ================== TABLE ==================
function renderTable(data) {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    data.forEach(r => {
        tbody.innerHTML += `
        <tr>
            <td>${r.MSNV || ""}</td>
            <td>${r.FullName || ""}</td>
            <td>${excelDate(r.NgayDieuChinh)}</td>
            <td>${r.NoiDung || ""}</td>
            <td><span class="badge ${r.ConfirmAdmin ? "confirm-done" : "confirm-none"}">
                ${r.ConfirmAdmin || "Ch∆∞a ph·∫£n h·ªìi"}
            </span></td>
            <td>${r.BU || ""}</td>
            <td>${r.Team || ""}</td>
        </tr>`;
    });
}

// ================== SORT ==================
function sortTable(column) {
    sortState[column] = !sortState[column];

    viewData.sort((a, b) => {
        let valA = a[column];
        let valB = b[column];

        if (column === "MSNV") {
            valA = Number(valA) || 0;
            valB = Number(valB) || 0;
        }

        if (column === "NgayDieuChinh") {
            valA = excelSerialToDate(valA);
            valB = excelSerialToDate(valB);
        }

        if (valA < valB) return sortState[column] ? -1 : 1;
        if (valA > valB) return sortState[column] ? 1 : -1;
        return 0;
    });

    currentPage = 1;
    renderAll(viewData);
}

// ================== SEARCH ==================
function applySearch() {
    const msnv = document.getElementById("searchMSNV").value.trim().toLowerCase();
    const name = document.getElementById("searchName").value.trim().toLowerCase();

    viewData = fullData.filter(r =>
        (!msnv || (r.MSNV || "").toString().toLowerCase().includes(msnv)) &&
        (!name || (r.FullName || "").toLowerCase().includes(name))
    );

    currentPage = 1;
    renderAll(viewData);
}

function resetFilter() {
    document.getElementById("searchMSNV").value = "";
    document.getElementById("searchName").value = "";
    viewData = [...fullData];
    currentPage = 1;
    renderAll(viewData);
}

// ================== CHART ANIMATION CONFIG ==================
function barAnimateCfg() {
    return {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
            duration: 1200,
            easing: "easeOutElastic"
        },
        animations: {
            y: {
                delay: ctx => ctx.dataIndex * 70
            }
        },
        plugins: {
            legend: { display: false },
            datalabels: {
                anchor: "end",
                align: "top",
                color: "#111827",
                font: { weight: "bold", size: 11 },
                formatter: v => v
            }
        },
        scales: {
            x: { ticks: { autoSkip: true, maxRotation: 45, minRotation: 0 } },
            y: { beginAtZero: true, precision: 0 }
        }
    };
}

function pieAnimateCfg() {
    return {
        responsive: true,
        maintainAspectRatio: false,
        animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1000
        },
        plugins: {
            legend: { position: "bottom" },
            datalabels: {
                color: "#ffffff",
                font: { weight: "bold", size: 11 },
                formatter: v => v
            }
        }
    };
}

// ================== DESTROY OLD CHARTS ==================
function destroyCharts() {
    [chartBUInstance, chartTeamInstance, chartTopInstance, chartNgayInstance].forEach(c => {
        if (c) c.destroy();
    });
    chartBUInstance = chartTeamInstance = chartTopInstance = chartNgayInstance = null;
}

// ================== CHARTS ==================
function renderTop(data) {
    const counts = {};
    data.forEach(r => {
        if (!r.FullName) return;
        counts[r.FullName] = (counts[r.FullName] || 0) + 1;
    });
    const sorted = Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,10);

    chartTopInstance = new Chart(document.getElementById("chartTop"), {
        type: "bar",
        data:{
            labels: sorted.map(x => x[0]),
            datasets:[{
                label: "S·ªë ph·∫£n h·ªìi",
                data: sorted.map(x => x[1]),
                backgroundColor:"#4C8BF5"
            }]
        },
        plugins: [ChartDataLabels],
        options: barAnimateCfg()
    });
}

function renderBU(data) {
    const counts = {};
    data.forEach(r => {
        const key = r.BU || "Kh√°c";
        counts[key] = (counts[key] || 0) + 1;
    });

    chartBUInstance = new Chart(document.getElementById("chartBU"), {
        type:"pie",
        data:{
            labels: Object.keys(counts),
            datasets:[{
                label: "S·ªë ph·∫£n h·ªìi",
                data:Object.values(counts),
                backgroundColor:["#f97373","#60a5fa","#facc15","#4ade80","#a855f7","#fb923c"]
            }]
        },
        plugins: [ChartDataLabels],
        options: pieAnimateCfg()
    });
}

function renderTeam(data) {
    const counts = {};
    data.forEach(r => {
        const key = r.Team || "Kh√°c";
        counts[key] = (counts[key] || 0) + 1;
    });

    chartTeamInstance = new Chart(document.getElementById("chartTeam"), {
        type:"bar",
        data:{
            labels:Object.keys(counts),
            datasets:[{
                label:"S·ªë ph·∫£n h·ªìi",
                data:Object.values(counts),
                backgroundColor:"#fb923c"
            }]
        },
        plugins: [ChartDataLabels],
        options: barAnimateCfg()
    });
}

function renderNgayChinh(data) {
    const counts = {};
    data.forEach(r => {
        const label = excelDate(r.NgayDieuChinh);
        if (!label) return;
        counts[label] = (counts[label] || 0) + 1;
    });

    chartNgayInstance = new Chart(document.getElementById("chartNgayChinh"), {
        type:"bar",
        data:{
            labels:Object.keys(counts),
            datasets:[{
                label:"S·ªë ph·∫£n h·ªìi",
                data:Object.values(counts),
                backgroundColor:"#a855f7"
            }]
        },
        plugins: [ChartDataLabels],
        options: barAnimateCfg()
    });
}

// ================== AUTO MUSIC ==================
const music = document.getElementById("bgMusic");

// PC c·ªë play lu√¥n
music.play().catch(() => {});

// iOS / Mobile: c·∫ßn user t∆∞∆°ng t√°c
document.addEventListener("touchstart", () => music.play(), { once: true });
document.addEventListener("click", () => music.play(), { once: true });
</script>

</body>
</html>
