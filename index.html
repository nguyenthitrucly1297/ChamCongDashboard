<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>üìÖ Dashboard Ph·∫£n H·ªìi Ch·∫•m C√¥ng ‚Äì WAREHOUSE RYOBI</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Font ti·∫øng Vi·ªát -->
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet" />

<!-- ChartJS + DataLabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<style>
/* ===================== COLOR THEME (AUTO DARK MODE) ===================== */
:root {
    --bg: radial-gradient(circle at top, #e0f7ff 0, #f5f7fa 40%, #edf2ff 100%);
    --text: #111827;
    --box: #ffffff;
    --box-border: #d1d5db;
    --accent: #22d3ee;
}
@media (prefers-color-scheme: dark) {
    :root {
        --bg: radial-gradient(circle at top, #020617 0, #020617 40%, #0f172a 100%);
        --text: #e5e7eb;
        --box: #020617;
        --box-border: #1f2933;
        --accent: #38bdf8;
    }
}

/* ===================== GLOBAL ===================== */
* { box-sizing: border-box; }

body {
    margin: 20px;
    font-family: "Be Vietnam Pro", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    color: var(--text);
    background: var(--bg);
    min-height: 100vh;
    transition: background 0.3s ease, color 0.3s ease;
}

/* ===================== TITLE ===================== */
h1 {
    text-align: center;
    font-size: 38px;
    font-weight: 800;
    margin: 0 0 6px 0;
    letter-spacing: 0.04em;
    background: linear-gradient(90deg, #4facfe, #00f2fe);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow:
        0 0 10px rgba(56, 189, 248, 0.6),
        0 0 24px rgba(59, 130, 246, 0.9);
}

h2 {
    margin-top: 22px;
    margin-bottom: 6px;
    font-size: 20px;
    font-weight: 700;
}

/* ===================== SEARCH BAR ===================== */
.search-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
    margin-bottom: 10px;
}

.search-bar input {
    padding: 8px 10px;
    width: 190px;
    border-radius: 999px;
    border: 1px solid var(--box-border);
    background: var(--box);
    color: var(--text);
    outline: none;
    box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.02);
}

.search-bar button {
    padding: 8px 14px;
    border-radius: 999px;
    border: none;
    cursor: pointer;
    font-weight: 600;
    background: linear-gradient(135deg, #f97316, #ec4899);
    color: #fff;
    box-shadow: 0 10px 25px rgba(236, 72, 153, 0.35);
    transition: transform 0.08s ease, box-shadow 0.08s ease;
}
.search-bar button:hover {
    transform: translateY(-1px);
    box-shadow: 0 14px 30px rgba(236, 72, 153, 0.45);
}

/* ===================== TABLE ===================== */
.table-wrapper {
    background: rgba(15, 23, 42, 0.03);
    border-radius: 16px;
    padding: 10px;
}

table {
    width: 100%;
    border-collapse: collapse;
    background: var(--box);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
}

th, td {
    padding: 9px 10px;
    border-bottom: 1px solid var(--box-border);
    font-size: 13px;
}

th {
    background: rgba(15, 23, 42, 0.03);
    text-align: left;
    font-weight: 600;
    user-select: none;
}

th.sortable {
    cursor: pointer;
}

tbody tr:nth-child(2n) {
    background-color: rgba(148, 163, 184, 0.04);
}

/* Badge */
.badge {
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 600;
    color: #fff;
    white-space: nowrap;
}
.confirm-none  { background: #f97373; }
.confirm-done  { background: #22c55e; }

/* ===================== PAGINATION ===================== */
.pagination {
    margin-top: 8px;
    display: flex;
    justify-content: flex-end;
    align-items: center;
    gap: 8px;
    font-size: 13px;
}

.pagination button {
    padding: 5px 10px;
    border-radius: 999px;
    border: 1px solid var(--box-border);
    background: var(--box);
    color: var(--text);
    cursor: pointer;
    min-width: 80px;
}
.pagination button:disabled {
    opacity: 0.4;
    cursor: default;
}

/* ===================== CHARTS ===================== */
.chart-box {
    background: var(--box);
    border-radius: 16px;
    padding: 14px 14px 10px 14px;
    margin-top: 16px;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
    border: 1px solid rgba(148,163,184,0.35);
}

.chart-box h3 {
    margin: 0 0 6px 0;
    font-size: 15px;
}

/* Layout footer charts */
.footer-layout {
    display: grid;
    gap: 16px;
}

.footer-row {
    display: grid;
    grid-template-columns: minmax(0,1fr) minmax(0,2fr);
    gap: 16px;
}
.full-row {
    grid-column: 1 / -1;
}

/* Responsive */
@media (max-width: 900px) {
    .footer-row { grid-template-columns: minmax(0,1fr); }
}

/* ===================== AUDIO ===================== */
audio { display: none; }

</style>
</head>
<body>

<h1>Dashboard Ph·∫£n H·ªìi Ch·∫•m C√¥ng ‚Äì WAREHOUSE RYOBI</h1>
<p>üïì D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông ‚ù§Ô∏èü´∂‚ù§Ô∏è</p>

<!-- SEARCH -->
<div class="search-bar">
    <input id="searchMSNV" placeholder="T√¨m theo MSNV‚Ä¶" />
    <input id="searchName" placeholder="T√¨m theo h·ªç t√™n‚Ä¶" />
    <button id="clearFilterBtn">X√≥a l·ªçc</button>
</div>

<h2>Danh s√°ch chi ti·∫øt</h2>

<div class="table-wrapper">
    <table id="dataTable">
        <thead>
            <tr>
                <th class="sortable" data-col="MSNV">MSNV ‚¨ç</th>
                <th>H·ªç t√™n</th>
                <th class="sortable" data-col="NgayDieuChinh">Ng√†y c·∫ßn ƒëi·ªÅu ch·ªânh ‚¨ç</th>
                <th>N·ªôi dung</th>
                <th>Confirm</th>
                <th>BU</th>
                <th>Team</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <div class="pagination">
        <span id="pageInfo">Trang 1/1</span>
        <button id="prevPageBtn">Trang tr∆∞·ªõc</button>
        <button id="nextPageBtn">Trang sau</button>
    </div>
</div>

<!-- FOOTER CHARTS -->
<h2>Bi·ªÉu ƒë·ªì ph·ª•</h2>

<div class="footer-layout">

    <!-- Row 1: BU + Team -->
    <div class="footer-row">
        <div class="chart-box">
            <h3>Theo BU</h3>
            <canvas id="chartBU"></canvas>
        </div>

        <div class="chart-box">
            <h3>Theo Team</h3>
            <canvas id="chartTeam"></canvas>
        </div>
    </div>

    <!-- Row 2: Top ph·∫£n h·ªìi -->
    <div class="chart-box full-row">
        <h3>Top ph·∫£n h·ªìi</h3>
        <canvas id="chartTop"></canvas>
    </div>

    <!-- Row 3: Theo ng√†y ch·ªânh -->
    <div class="chart-box full-row">
        <h3>Theo ng√†y ch·ªânh</h3>
        <canvas id="chartNgay"></canvas>
    </div>
</div>

<!-- BACKGROUND MUSIC -->
<audio id="bgMusic" loop>
    <!-- ƒê·ªïi t√™n file n√†y cho kh·ªõp repo c·ªßa b·∫°n -->
    <source src="NhacGiangSinh.mp3" type="audio/mpeg" />
</audio>

<script>
/* ===================== CONFIG ===================== */
const jsonUrl = "https://hoailuan0311-code.github.io/ChamCongDashboard/data.json";
const ROWS_PER_PAGE = 30;

let fullData = [];
let viewData = [];          // d·ªØ li·ªáu sau khi filter/sort
let currentPage = 1;
let sortState = { col: null, dir: 1 }; // 1 = asc, -1 = desc

// Chart instances (ƒë·ªÉ destroy tr∆∞·ªõc khi v·∫Ω l·∫°i)
let chartBUInst = null;
let chartTeamInst = null;
let chartTopInst = null;
let chartNgayInst = null;

// L·∫•y m√†u ch·ªØ hi·ªán t·∫°i -> d√πng cho DataLabels
function getLabelColor() {
    const rootStyle = getComputedStyle(document.documentElement);
    const c = rootStyle.getPropertyValue("--text").trim();
    return c || "#111";
}

// Convert Excel serial date ‚Üí dd-MMM-yyyy
function excelDate(v) {
    if (!v) return "";
    const d = new Date((v - 25569) * 86400 * 1000);
    if (isNaN(d)) return v;
    return d.toLocaleDateString("en-GB", {
        day: "2-digit",
        month: "short",
        year: "numeric"
    });
}

/* ===================== LOAD DATA ===================== */
async function loadData() {
    const res = await fetch(jsonUrl + "?cache=" + Date.now());
    fullData = await res.json();
    // ban ƒë·∫ßu: viewData = fullData
    applyFilterAndSort();
}
loadData();

/* ===================== FILTER + SORT + PAGINATION ===================== */
const searchMSNV = document.getElementById("searchMSNV");
const searchName = document.getElementById("searchName");
const clearFilterBtn = document.getElementById("clearFilterBtn");

searchMSNV.addEventListener("input", () => applyFilterAndSort(true));
searchName.addEventListener("input", () => applyFilterAndSort(true));

clearFilterBtn.addEventListener("click", () => {
    searchMSNV.value = "";
    searchName.value = "";
    sortState = { col: null, dir: 1 };
    currentPage = 1;
    applyFilterAndSort();
});

function applyFilterAndSort(resetPage = false) {
    let ms = searchMSNV.value.trim().toLowerCase();
    let nm = searchName.value.trim().toLowerCase();

    viewData = fullData.filter(r =>
        (!ms || String(r.MSNV || "").toLowerCase().includes(ms)) &&
        (!nm || String(r.FullName || "").toLowerCase().includes(nm))
    );

    if (sortState.col) {
        const col = sortState.col;
        const dir = sortState.dir;
        viewData.sort((a, b) => {
            const va = a[col] ?? "";
            const vb = b[col] ?? "";
            if (va > vb) return dir;
            if (va < vb) return -dir;
            return 0;
        });
    }

    if (resetPage) currentPage = 1;
    renderAll();
}

/* ===================== SORT HANDLERS ===================== */
document.querySelectorAll("th.sortable").forEach(th => {
    th.addEventListener("click", () => {
        const col = th.dataset.col;
        if (sortState.col === col) {
            sortState.dir *= -1;         // ƒë·∫£o chi·ªÅu sort
        } else {
            sortState.col = col;
            sortState.dir = 1;
        }
        currentPage = 1;
        applyFilterAndSort();
    });
});

/* ===================== PAGINATION HANDLERS ===================== */
const prevPageBtn = document.getElementById("prevPageBtn");
const nextPageBtn = document.getElementById("nextPageBtn");
const pageInfo = document.getElementById("pageInfo");

prevPageBtn.addEventListener("click", () => {
    if (currentPage > 1) {
        currentPage--;
        renderTable();
    }
});

nextPageBtn.addEventListener("click", () => {
    const totalPages = Math.max(1, Math.ceil(viewData.length / ROWS_PER_PAGE));
    if (currentPage < totalPages) {
        currentPage++;
        renderTable();
    }
});

/* ===================== RENDER TABLE ===================== */
function renderTable() {
    const tbody = document.querySelector("#dataTable tbody");
    tbody.innerHTML = "";

    const totalPages = Math.max(1, Math.ceil(viewData.length / ROWS_PER_PAGE));
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * ROWS_PER_PAGE;
    const end = start + ROWS_PER_PAGE;
    const pageData = viewData.slice(start, end);

    pageData.forEach(r => {
        tbody.innerHTML += `
            <tr>
                <td>${r.MSNV ?? ""}</td>
                <td>${r.FullName ?? ""}</td>
                <td>${excelDate(r.NgayDieuChinh)}</td>
                <td>${r.NoiDung ?? ""}</td>
                <td>
                    <span class="badge ${r.ConfirmAdmin ? "confirm-done" : "confirm-none"}">
                        ${r.ConfirmAdmin || "Ch∆∞a ph·∫£n h·ªìi"}
                    </span>
                </td>
                <td>${r.BU ?? ""}</td>
                <td>${r.Team ?? ""}</td>
            </tr>
        `;
    });

    pageInfo.textContent = `Trang ${currentPage}/${totalPages}`;
    prevPageBtn.disabled = currentPage <= 1;
    nextPageBtn.disabled = currentPage >= totalPages;
}

/* ===================== RENDER CHARTS ===================== */
Chart.register(ChartDataLabels);

function renderAll() {
    renderTable();
    renderBU();
    renderTeam();
    renderTop();
    renderNgay();
}

function destroyIfExists(chartInstance) {
    if (chartInstance && typeof chartInstance.destroy === "function") {
        chartInstance.destroy();
    }
}

function renderBU() {
    const counts = {};
    viewData.forEach(r => {
        const key = r.BU || "Kh√°c";
        counts[key] = (counts[key] || 0) + 1;
    });

    destroyIfExists(chartBUInst);

    chartBUInst = new Chart(document.getElementById("chartBU"), {
        type: "pie",
        data: {
            labels: Object.keys(counts),
            datasets: [{
                data: Object.values(counts),
                backgroundColor: ["#fb7185", "#3b82f6", "#22c55e", "#f97316", "#a855f7"]
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            plugins: {
                legend: { position: "bottom" },
                datalabels: {
                    color: "#ffffff",
                    font: { weight: "bold", size: 11 },
                    formatter: (v) => v
                }
            },
            animation: {
                duration: 1100,
                easing: "easeOutBack"
            }
        }
    });
}

function renderTeam() {
    const counts = {};
    viewData.forEach(r => {
        const key = r.Team || "Kh√°c";
        counts[key] = (counts[key] || 0) + 1;
    });

    destroyIfExists(chartTeamInst);

    chartTeamInst = new Chart(document.getElementById("chartTeam"), {
        type: "bar",
        data: {
            labels: Object.keys(counts),
            datasets: [{
                label: "S·ªë ph·∫£n h·ªìi",
                data: Object.values(counts),
                backgroundColor: "#f97316"
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            indexAxis: "x",
            responsive: true,
            scales: {
                x: {
                    ticks: {
                        autoSkip: false,
                        maxRotation: 60,
                        minRotation: 30
                    }
                },
                y: { beginAtZero: true }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    anchor: "end",
                    align: "top",
                    color: getLabelColor(),
                    font: { weight: "bold", size: 11 }
                }
            },
            animation: {
                duration: 1200,
                easing: "easeOutElastic"
            }
        }
    });
}

function renderTop() {
    const counts = {};
    viewData.forEach(r => {
        const key = r.FullName || "Kh√¥ng t√™n";
        counts[key] = (counts[key] || 0) + 1;
    });

    const sorted = Object.entries(counts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

    destroyIfExists(chartTopInst);

    chartTopInst = new Chart(document.getElementById("chartTop"), {
        type: "bar",
        data: {
            labels: sorted.map(x => x[0]),
            datasets: [{
                label: "S·ªë ph·∫£n h·ªìi",
                data: sorted.map(x => x[1]),
                backgroundColor: "#0ea5e9"
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    anchor: "end",
                    align: "top",
                    color: getLabelColor(),
                    font: { weight: "bold", size: 11 }
                }
            },
            animation: {
                duration: 1300,
                easing: "easeOutQuad"
            }
        }
    });
}

function renderNgay() {
    const counts = {};
    viewData.forEach(r => {
        const d = excelDate(r.NgayDieuChinh);
        if (!d) return;
        counts[d] = (counts[d] || 0) + 1;
    });

    destroyIfExists(chartNgayInst);

    chartNgayInst = new Chart(document.getElementById("chartNgay"), {
        type: "bar",
        data: {
            labels: Object.keys(counts),
            datasets: [{
                label: "S·ªë ph·∫£n h·ªìi",
                data: Object.values(counts),
                backgroundColor: "#a855f7"
            }]
        },
        plugins: [ChartDataLabels],
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true }
            },
            plugins: {
                legend: { display: false },
                datalabels: {
                    anchor: "end",
                    align: "top",
                    color: getLabelColor(),
                    font: { weight: "bold", size: 11 }
                }
            },
            animation: {
                duration: 1400,
                easing: "easeOutBounce"
            }
        }
    });
}

/* ===================== BACKGROUND MUSIC ===================== */
const bgMusic = document.getElementById("bgMusic");

// PC ‚Äì c·ªë g·∫Øng autoplay
bgMusic.play().catch(() => { /* ignore */ });

// Mobile / iOS c·∫ßn t∆∞∆°ng t√°c
document.addEventListener("click", () => bgMusic.play().catch(() => {}), { once: true });
document.addEventListener("touchstart", () => bgMusic.play().catch(() => {}), { once: true });

</script>
</body>
</html>
